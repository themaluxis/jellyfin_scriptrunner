<!DOCTYPE html>
<html lang="en">
<head>
    <title>Shell Executor</title>
</head>
<body>
    <div id="shellExecutorConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="shellExecutorConfigForm">
                    <div class="sectionTitleContainer">
                        <h2 class="sectionTitle">Shell Executor Configuration</h2>
                    </div>
                    <div class="verticalSection">
                        <div class="inputContainer">
                            <label class="inputLabel" for="scriptContent">Script Content</label>
                            <textarea id="scriptContent" class="emby-textarea" rows="20" style="font-family: monospace; width: 100%;"></textarea>
                            <div class="fieldDescription">Edit the shell script that will be executed when the plugin initializes.</div>
                        </div>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                        <button is="emby-button" type="button" class="raised button-cancel block emby-button" id="executeNow">
                            <span>Execute Now</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var ShellExecutorConfig = {
                pluginUniqueId: 'eb5d7894-8eef-4b36-aa7f-5d124e828ce1'
            };

            $('#shellExecutorConfigPage').on('pageshow', function() {
                Dashboard.showLoadingMsg();
                
                ApiClient.getPluginConfiguration(ShellExecutorConfig.pluginUniqueId).then(function(config) {
                    console.log('Loaded configuration:', config);
                    
                    // Set the script content
                    var scriptContent = config.ScriptContent || '';
                    $('#scriptContent').val(scriptContent);
                    
                    console.log('Script content length:', scriptContent.length);
                    
                    Dashboard.hideLoadingMsg();
                }).catch(function(error) {
                    console.error('Failed to load configuration:', error);
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert('Failed to load configuration: ' + error);
                });
            });

            $('#shellExecutorConfigForm').on('submit', function(e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                
                var scriptContent = $('#scriptContent').val();
                console.log('Saving script content, length:', scriptContent.length);
                
                ApiClient.getPluginConfiguration(ShellExecutorConfig.pluginUniqueId).then(function(config) {
                    config.ScriptContent = scriptContent;
                    
                    ApiClient.updatePluginConfiguration(ShellExecutorConfig.pluginUniqueId, config).then(function(result) {
                        console.log('Configuration saved:', result);
                        Dashboard.processPluginConfigurationUpdateResult();
                    }).catch(function(error) {
                        console.error('Failed to save configuration:', error);
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to save configuration: ' + error);
                    });
                });
                
                return false;
            });

            $('#executeNow').on('click', function() {
                Dashboard.showLoadingMsg();
                
                // First save the current script content
                var scriptContent = $('#scriptContent').val();
                console.log('Executing script, content length:', scriptContent.length);
                
                ApiClient.getPluginConfiguration(ShellExecutorConfig.pluginUniqueId).then(function(config) {
                    config.ScriptContent = scriptContent;
                    
                    ApiClient.updatePluginConfiguration(ShellExecutorConfig.pluginUniqueId, config).then(function() {
                        console.log('Configuration saved, now executing...');
                        
                        // Then execute the script
                        var url = ApiClient.getUrl('plugins/shellexecutor/Execute');
                        
                        ApiClient.ajax({
                            type: 'POST',
                            url: url,
                            headers: {
                                'X-MediaBrowser-Token': ApiClient.accessToken()
                            }
                        }).then(function(result) {
                            console.log('Execution result:', result);
                            Dashboard.hideLoadingMsg();
                            
                            if (result && result.Success) {
                                Dashboard.alert('Script executed successfully. Check the logs for output.');
                            } else {
                                Dashboard.alert('Script execution failed: ' + (result ? result.Message : 'Unknown error'));
                            }
                        }).catch(function(error) {
                            console.error('Execution error:', error);
                            Dashboard.hideLoadingMsg();
                            Dashboard.alert('Failed to execute script: ' + error);
                        });
                    });
                });
            });
        </script>
    </div>
</body>
</html>